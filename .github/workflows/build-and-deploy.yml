name: build-and-deploy

on:
  push:
    paths:
    - '.github/workflows/build-and-deploy.yml'
    - 'src/**'
  pull_request:
    paths:
    - '.github/workflows/build-and-deploy.yml'
    - 'src/**'

env:
  has_v_tag: ${{ startsWith(github.ref, 'refs/tags/v') }}
  is_default_branch: ${{ github.ref == 'refs/heads/main' }}
  is_release_branch: ${{ startsWith(github.ref, 'refs/heads/release') }}
  is_tagged_or_default_branch: ${{ fromJSON(env.has_v_tag) || fromJSON(env.is_default_branch) }}

jobs:

  build:

    runs-on: ubuntu-latest
    steps:
    - name: 'Dump'
      run: |
        echo "always has_v_tag=$has_v_tag"
        echo "is_default_branch=$is_default_branch"
        echo "is_release_branch=$is_release_branch"

    - name: 'If default branch'
      if: ${{ github.ref == 'refs/heads/main' }}
      run: 'echo "on default branch"'
    - name: 'If release branch'
      if: ${{ startsWith(github.ref, 'refs/heads/release') }}
      run: 'echo "on release branch ${{ github.ref }}"'
    - name: 'If tagged'
      if: ${{ startsWith(github.ref, 'refs/tags/v') }}
      run: 'echo "v-tagged"'
    - name: 'If tagged or default branch'
      if: ${{ startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' }}
      run: 'echo "v-tagged or main"'

    - name: 'If default branch [env]'
      if: ${{ fromJSON(env.is_default_branch) }}
      run: 'echo "on default branch"'
    - name: 'If release branch'
      if: ${{ fromJSON(env.is_release_branch) }}
      run: 'echo "on release branch ${{ github.ref }}"'
    - name: 'If tagged [env]'
      if: ${{ fromJSON(env.has_v_tag) }}
      run: 'echo "tagged"'
    - name: 'If tagged or default branch [env]'
      if: ${{ fromJSON(env.has_v_tag) || fromJSON(env.is_default_branch) }}
      run: 'echo "v-tagged or main"'

    - name: 'If tagged or default branch [env]'
      if: ${{ fromJSON(env.is_tagged_or_default_branch) }}
      run: 'echo "v-tagged or main"'


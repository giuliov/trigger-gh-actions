name: build-and-deploy

on:
  workflow_dispatch: # allow manual queueing
  push: # trigger for push of commits, tags, opening of a PR
    paths:
    - '.github/workflows/build-and-deploy.yml'
    - 'src/**'
  pull_request:
    paths:
    - '.github/workflows/build-and-deploy.yml'
    - 'src/**'

env:
  has_v_tag: ${{ startsWith(github.ref, 'refs/tags/v') }}
  # NB github.ref for a PR is refs/pull/... 
  is_default_branch: ${{ github.ref == 'refs/heads/main' }}
  is_release_branch: ${{ startsWith(github.ref, 'refs/heads/release') }}
  ## this won't work as env context is not available at the workflow (top/root) level
  #is_tagged_or_default_branch: ${{ fromJSON(env.has_v_tag) || fromJSON(env.is_default_branch) }}
  is_tagged_or_default_branch: ${{ startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' }}
  triggered_by: ${{ github.event_name }}
  target_branch: ${{ github.base_ref }}
  source_branch: ${{ github.head_ref }}
  is_pull_request: ${{ github.event_name == 'pull_request' }}
  # any PR, any push to default branch, 
  run_integration_tests: ${{ github.event_name == 'pull_request' || github.ref == 'refs/heads/main' }}
  release_new_version: ${{ startsWith(github.ref, 'refs/tags/v') }}

jobs:

  build:

    runs-on: ubuntu-latest
    steps:
    - name: 'Dump'
      run: |
        echo "always has_v_tag = $has_v_tag"
        echo "is_default_branch = $is_default_branch"
        echo "is_release_branch = $is_release_branch"
        echo "triggered_by = $triggered_by"
        echo "target_branch = $target_branch"
        echo "source_branch = $source_branch"

    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJSON(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: 'If run_integration_tests'
      if: ${{ fromJSON(env.run_integration_tests) }}
      run: 'echo "Integration tests running..."'
    - name: 'If release_new_version'
      if: ${{ fromJSON(env.release_new_version) }}
      run: 'echo "Releasing a new version..."'

    - name: 'If default branch'
      if: ${{ github.ref == 'refs/heads/main' }}
      run: 'echo "on default branch"'
    - name: 'If release branch'
      if: ${{ startsWith(github.ref, 'refs/heads/release') }}
      run: 'echo "on release branch ${{ github.ref }}"'
    - name: 'If tagged'
      if: ${{ startsWith(github.ref, 'refs/tags/v') }}
      run: 'echo "v-tagged"'
    - name: 'If tagged or default branch'
      if: ${{ startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' }}
      run: 'echo "v-tagged or main"'

    - name: 'If default branch [env]'
      if: ${{ fromJSON(env.is_default_branch) }}
      run: 'echo "on default branch"'
    - name: 'If release branch'
      if: ${{ fromJSON(env.is_release_branch) }}
      run: 'echo "on release branch ${{ github.ref }}"'
    - name: 'If tagged [env]'
      if: ${{ fromJSON(env.has_v_tag) }}
      run: 'echo "tagged"'
    - name: 'If tagged or default branch [env]'
      if: ${{ fromJSON(env.has_v_tag) || fromJSON(env.is_default_branch) }}
      run: 'echo "v-tagged or main"'

    - name: 'If tagged or default branch [env]'
      if: ${{ fromJSON(env.is_tagged_or_default_branch) }}
      run: 'echo "v-tagged or main"'

